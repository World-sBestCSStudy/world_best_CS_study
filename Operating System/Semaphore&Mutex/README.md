# 세마포어와 뮤텍스

# 세마포어 (Semaphore)

세마포어는 멀티프로그래밍 환경에서 **공유 자원에 대한 접근을 제한하는 방법**으로, 여러 프로세스가 동시에 접근할 때 발생할 수 있는 문제를 해결하기 위해 사용됩니다. 세마포어는 두 가지 주요 연산, **P 연산과 V 연산을 사용하여 임계 구역에 대한 접근을 제어**합니다.

### 임계 구역 (Critical Section)

임계 구역은 여러 프로세스가 데이터를 공유하며 수행되는 프로그램 코드 부분입니다. 여러 프로세스가 동시에 접근할 때 잘못된 결과를 만들 수 있으므로, **한 프로세스가 임계 구역을 수행할 때는 다른 프로세스가 접근하지 못하도록 해야 합니다.**

### 세마포어 P, V 연산

- **P 연산 (Wait 연산)**: 임계 구역에 들어가기 전에 수행합니다. 자원의 개수(S)를 통해 프로세스 진입 여부를 결정합니다.
- **V 연산 (Signal 연산)**: 임계 구역에서 나올 때 수행합니다. 자원 반납을 알리고 대기 중인 프로세스를 깨우는 신호를 보냅니다.

```html
procedure P(S) --> 최초 S값은 1임 while S=0 do wait --> S가 0면 1이 될때까지
기다려야 함 S := S-1 --> S를 0로 만들어 다른 프로세스가 들어 오지 못하도록 함
end P --- 임계 구역 --- procedure V(S) --> 현재상태는 S가 0임 S := S+1 --> S를
1로 원위치시켜 해제하는 과정 end V
```

### 예시

최초 S 값이 1이고, 프로세스 A와 B가 있다고 가정합니다:

1. 프로세스 A가 P(S)를 실행하여 S를 0으로 만들고 임계 구역에 들어갑니다.
2. 프로세스 B가 P(S)를 실행하지만, S가 0이므로 대기 상태에 들어갑니다.
3. 프로세스 A가 임계 구역을 마치고 V(S)를 실행하면 S는 다시 1이 됩니다.
4. 프로세스 B는 P(S)에서 기다리던 상태를 벗어나 임계 구역에 들어갑니다.

## 뮤텍스

뮤텍스는 **임계 구역을 가진 스레드들의 실행 시간이 서로 겹치지 않고 각각 단독으로 실행되도록 하는 기술**입니다. 뮤텍스는 상호 배제(Mutual Exclusion)의 약자로, **한 번에 하나의 스레드만 임계 구역에 들어갈 수 있게 합니다**. 접근을 조율하기 위해 lock과 unlock을 사용합니다.

### 뮤텍스 연산

- **lock**: 현재 임계 구역에 들어갈 권한을 얻어옵니다. 다른 프로세스/스레드가 임계 구역을 수행 중이면 종료할 때까지 대기합니다.
- **unlock**: 현재 임계 구역을 모두 사용했음을 알립니다. 대기 중인 다른 프로세스/스레드가 임계 구역에 진입할 수 있게 됩니다.

```html
pthread_mutex_t lock; void *thread_function(void *arg) {
pthread_mutex_lock(&lock); // 임계 구역 진입 시도 // --- 임계 구역 ---
pthread_mutex_unlock(&lock); // 임계 구역 진입 해제 return NULL; }
```

뮤텍스는 상태가 0과 1로만 변할 수 있어, 이진 세마포어(Binary Semaphore)로 불리기도 합니다.

### 뮤텍스 알고리즘

### 데커(Dekker) 알고리즘

데커 알고리즘은 flag와 turn 변수를 통해 임계 구역에 들어갈 프로세스/스레드를 결정하는 방식입니다.

- **flag**: 프로세스 중 누가 임계 구역에 진입할 것인지 나타내는 변수입니다.
- **turn**: 누가 임계 구역에 들어갈 차례인지 나타내는 변수입니다.

```c
while(true) {
    flag[i] = true; // 프로세스 i가 임계 구역 진입 시도
    while(flag[j]) { // 프로세스 j가 현재 임계 구역에 있는지 확인
        if(turn == j) { // j가 임계 구역 사용 중이면
            flag[i] = false; // 프로세스 i 진입 취소
            while(turn == j); // turn이 j에서 변경될 때까지 대기
            flag[i] = true; // j turn이 끝나면 다시 진입 시도
        }
    }
}

// ------- 임계 구역 ---------

turn = j; // 임계 구역 사용 끝나면 turn을 넘김
flag[i] = false; // flag 값을 false로 바꿔 임계 구역 사용 완료를 알림
```

### 장점:

역사적으로 최초의 상호 배제 알고리즘 중 하나

### 단점:

- **복잡성**: 비교적 복잡한 알고리즘으로, 코드가 길고 이해하기 어려울 수 있습니다.
- **스케일링 문제**: 두 프로세스에만 적합하며, 다중 프로세스 환경에서는 적용하기 어렵습니다.

### 피터슨(Peterson) 알고리즘

피터슨 알고리즘은 데커 알고리즘과 유사하지만, 상대방 프로세스/스레드에게 진입 기회를 양보하는 것이 차이점입니다.

```c
while(true) {
    flag[i] = true; // 프로세스 i가 임계 구역 진입 시도
    turn = j; // 다른 프로세스에게 진입 기회 양보
    while(flag[j] && turn == j) { // 다른 프로세스가 진입 시도하면 대기
    }
}

// ------- 임계 구역 ---------

flag[i] = false; // flag 값을 false로 바꿔 임계 구역 사용 완료를 알림
```

### 장점:

- **간결함**: 데커 알고리즘보다 간단하며 이해하기 쉽습니다.

### 단점:

- **스케일링 문제**: 두 프로세스에만 적합하며, 다중 프로세스 환경에서는 적용하기 어렵습니다.
- **하드웨어 지원 필요**: 알고리즘이 효과적으로 작동하려면 메모리 접근이 순서대로 이루어져야 하므로, 하드웨어 지원이 필요합니다.

### 제과점(Bakery) 알고리즘

제과점 알고리즘은 여러 프로세스/스레드가 임계 구역에 진입할 수 있는 번호표를 받아 가장 작은 번호표를 가진 프로세스가 진입하는 방식입니다.

```c
while(true) {

    isReady[i] = true; // 번호표 받을 준비
    number[i] = max(number[0~n-1]) + 1; // 현재 실행 중인 프로세스 중에 가장 큰 번호 배정
    isReady[i] = false; // 번호표 수령 완료

    for(j = 0; j < n; j++) { // 모든 프로세스 번호표 비교
        while(isReady[j]); // 비교 프로세스가 번호표 받을 때까지 대기
        while(number[j] && number[j] < number[i] && j < i);

        // 프로세스 j가 번호표 가지고 있어야 함
        // 프로세스 j의 번호표 < 프로세스 i의 번호표
    }
}

// ------- 임계 구역 ---------

number[i] = 0; // 임계 구역 사용 종료
```

### 장점:

- **다중 프로세스 지원**: 여러 프로세스가 동시에 경쟁하는 환경에서 사용할 수 있습니다.

### 단점:

- **복잡성**: 알고리즘이 상대적으로 복잡하여 구현과 이해가 어렵습니다.
- **번호표 오버헤드**: 프로세스가 번호표를 배정받고 비교하는 과정에서 오버헤드가 발생할 수 있습니다.

### 면접 질문

뮤텍스와 세마포어에 대해서 말해보세요.

"뮤텍스와 세마포어는 모두 동기화 도구로, 공유 자원에 대한 동시 접근을 제어하는 데 사용됩니다.

- **뮤텍스(Mutex)**는 'Mutual Exclusion(상호 배제)'의 약자로, 한 번에 하나의 스레드만 임계 구역에 들어갈 수 있도록 보장합니다. 뮤텍스는 `lock`과 `unlock` 연산을 사용하여 임계 구역에 대한 접근을 제어합니다. 예를 들어, 여러 스레드가 동일한 데이터를 수정할 때 뮤텍스를 사용하여 데이터 일관성을 유지할 수 있습니다.
- **세마포어(Semaphore\***는 공유 자원에 대한 접근을 제한하는 카운터 기반의 동기화 도구입니다. 세마포어는 `P` 연산(대기)과 `V` 연산(신호)을 사용하여 임계 구역에 대한 접근을 제어합니다. 예를 들어, 자원의 수를 제한하여 여러 프로세스가 동시에 자원에 접근하지 못하게 할 때 사용됩니다.

뮤텍스는 보통 이진 세마포어(0 또는 1)로 구현되며, 세마포어는 더 일반적인 형태로 여러 개의 자원을 관리할 수 있습니다."

세마포어는 완전히 동기화 문제를 해결할 수 는 없는 것 아닌가?

- **카운팅 세마포어**는 여러 프로세스가 동시에 자원에 접근할 수 있도록 허용하지만, 동기화 문제가 발생할 수 있습니다.
- 동기화 문제가 발생할 수 있는 임계 구역에서는 **이진 세마포어**를 사용하여 한 번에 하나의 프로세스만 접근하도록 제한합니다.
